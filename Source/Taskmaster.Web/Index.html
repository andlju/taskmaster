<!DOCTYPE html>
<html>
<head>
    <title>Taskmaster</title>
    <link href="Styles/Site.css" rel="stylesheet" type="text/css" />
    <script src="Scripts/jquery-1.6.2.min.js" type="text/javascript"></script>
    <script src="Scripts/knockout-1.3.0beta.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript">

        function Task(taskItemId, title, details) {
            this.taskItemId = ko.observable(taskItemId);
            this.title = ko.observable(title);
            this.details = ko.observable(details);

            var self = this;

            this.update = function () {
                $.ajax({
                    type: 'POST',
                    url: "/api/tasks",
                    data: ko.toJSON(self),
                    success: function (status) { alert(status); },
                    contentType: "application/json"
                });
            };
        }

        function TasksViewModel() {
            this.taskList = ko.observableArray([]);

            this.selectedTask = ko.observable();

            var self = this;

            this.refresh = function () {
                $.getJSON('/api/tasks', {}, function (data, status) {
                    var tmpList = $.map(data, function (item, no) {
                        return new Task(item.TaskItemId, item.Title, item.Details);
                    });
                    self.taskList(tmpList);
                });
            };

            this.addTask = function () {
                var newTask = new Task(0, "", "");

                self.taskList.push(newTask);
                self.selectedTask(newTask);
            };
        };

        var viewModel = new TasksViewModel();

        $(function () {

            ko.applyBindings(viewModel);
            viewModel.refresh();
        });
    
    </script>
    <h2>Title</h2>
    <div>
        <select data-bind="options: taskList,
                           optionsText: 'title',
                           value: selectedTask, 
                           optionsCaption: 'Choose...'">
        </select>
        <br/>
        <a href="#" data-bind="click: addTask" id="addTask">Add</a>

        <div data-bind="visible: selectedTask(), template: {name: 'selectedTaskTemplate', foreach: selectedTask}"></div>
        <script id="selectedTaskTemplate" type="text/html">
            <form>  
            <fieldset>
                <legend data-bind="text: 'Editing: ' + title()"></legend>
                <ul>
                    <li>
                        <label for="titleBox">Title</label>
                        <input id="titleBox" type="text" data-bind="value: title" />
                    </li>
                    <li>
                        <label for="detailsBox">Details</label>
                        <input id="detailsBox" type="text" data-bind="value: details" />
                    </li>
                </ul>
                <a href="#" data-bind="click: update" id="submitLink">Update</a>
            </fieldset>
            </form>
        </script>
    </div>
</body>
</html>
